mkdir -p ./data/postgres_db ./data/html

networks:
  nextcloud_net:
    driver: bridge
    
x-common-config: &common-config
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  environment:
    - TZ=Asia/Shanghai

services:
  postgres_db:
    <<: *common-config
    image: postgres:15-alpine
    container_name: nextcloud_postgres_db
    volumes:
      - ./data/db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: nextcloud
      POSTGRES_USER: ncuser
      POSTGRES_PASSWORD: Quee+K8Quo
    networks:
      - nextcloud_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ncuser -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
      

  redis:
    <<: *common-config
    image: redis:alpine
    container_name: nextcloud_redis
    networks:
      - nextcloud_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  app:
    <<: *common-config
    image: nextcloud:latest
    container_name: nextcloud_app
    depends_on:
      postgres_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '8583:80' 
    volumes:
      - ./data/html:/var/www/html 
      - /etc/localtime:/etc/localtime:ro
      
    environment:

      POSTGRES_HOST: postgres_db
      POSTGRES_DB: nextcloud
      POSTGRES_USER: ncuser
      POSTGRES_PASSWORD: Quee+K8Quo

      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: oHiegh7ief*ei2mohLah

      REDIS_HOST: redis
      # 启用 Nextcloud 的 Redis 文件锁定
      REDIS_HOST_FILOCk: redis
      # REDIS_PORT: 6379 (默认端口，可省略)
      
      # 允许 Nextcloud 访问的主机名（重要！）
      # NEXTCLOUD_TRUSTED_DOMAINS: "192.168.1.100 nextcloud.yourdomain.com"
      
    networks:
      - nextcloud_net
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s
