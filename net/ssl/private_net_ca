å…ˆå‡†å¤‡å¯†ç ï¼š
PL89velRt@+qBsl$

1ã€åˆ›å»ºç›®å½•ç»“æ„
mkdir -p ~/internal-ca/{certs,crl,newcerts,private}
touch ~/internal-ca/index.txt
echo 1000 > ~/internal-ca/serial
cd ~/internal-ca

2ã€ç”Ÿæˆæ ¹ CA ç§é’¥ï¼ˆ2048 æˆ– 4096 ä½ï¼‰
openssl genrsa -aes256 -out private/ca.key.pem 4096
chmod 400 private/ca.key.pem
è¾“å…¥æ–°å¯†ç 

3ã€ç”Ÿæˆæ ¹ CA è¯ä¹¦ï¼ˆæœ‰æ•ˆæœŸ 10 å¹´ï¼‰
openssl req -x509 -new -key private/ca.key.pem \
    -days 3650 \
    -sha256 \
    -extensions v3_ca \
    -out certs/ca.cert.pem \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=MyCompany Internal Root CA"
    
è¾“å…¥åŒä¸€å¯†ç 
å¦‚ï¼šopenssl req -x509 -new -key private/ca.key.pem \
    -days 3650 \
    -sha256 \
    -extensions v3_ca \
    -out certs/ca.cert.pem \
    -subj "/C=CN/ST=Chengdu/L=Chengdu/O=yematech.com/CN=yematech.com Internal Root CA"

4ã€ä¸ºæœåŠ¡å™¨ç”Ÿæˆç§é’¥
openssl genrsa -out private/server.key.pem 2048
chmod 400 private/server.key.pem

5ã€ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰
openssl req -new -key private/server.key.pem \
    -out server.csr \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=192.168.0.11" \
    -addext "subjectAltName = IP:192.168.0.11,DNS:myapp.local,DNS:localhost"
    
å¦‚ï¼šopenssl req -new -key private/server.key.pem \
    -out server.csr \
    -subj "/C=CN/ST=Chengdu/L=Chengdu/O=yematech.com/CN=192.168.0.14" \
    -addext "subjectAltName = IP:192.168.0.14,DNS:yematech.com,DNS:yematech.local,DNS:yematech.test"
    
6ã€ç”¨æ ¹ CA ç­¾å‘æœåŠ¡å™¨è¯ä¹¦
openssl x509 -req -in server.csr \
    -CA certs/ca.cert.pem \
    -CAkey private/ca.key.pem \
    -CAcreateserial \
    -out certs/server.cert.pem \
    -days 365 \
    -sha256 \
    -extfile <(printf "subjectAltName=IP:192.168.0.11,DNS:myapp.local,DNS:localhost")
    
è¾“å…¥åŒä¸€å¯†ç 
å¦‚ï¼šopenssl x509 -req -in server.csr \
    -CA certs/ca.cert.pem \
    -CAkey private/ca.key.pem \
    -CAcreateserial \
    -out certs/server.cert.pem \
    -days 365 \
    -sha256 \
    -extfile <(printf "subjectAltName=IP:192.168.0.14,DNS:yematech.com,DNS:yematech.local,DNS:yematech.test")  

7ã€éªŒè¯è¯ä¹¦å†…å®¹
openssl x509 -in certs/server.cert.pem -text -noout
æ£€æŸ¥ X509v3 Subject Alternative Name æ˜¯å¦åŒ…å«ä½ è®¾ç½®çš„ IP å’ŒåŸŸåã€‚


8ã€nginx é…ç½®
server {
    listen 443 ssl;
    server_name 192.168.0.11 yematech.com yematech.local yematech.test;

    ssl_certificate /path/to/internal-ca/certs/server.cert.pem;
    ssl_certificate_key /path/to/internal-ca/private/server.key.pem;

    # æ¨èå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # å¯é€‰ï¼šå¯ç”¨ OCSP Staplingï¼ˆå†…ç½‘æ—  OCSP æœåŠ¡å™¨ï¼Œå¯å…³é—­ï¼‰
    #ssl_stapling off;
    #ssl_stapling_verify off;

    location / {
        root /var/www/html;
        index index.html;
    }
}

# HTTP è·³è½¬ HTTPS
server {
    listen 80;
    server_name 192.168.0.11 yematech.com yematech.local yematech.test;
    return 301 https://$host$request_uri;
}

-------------------------------------------------------------------------------------
windowså®¢æˆ·ç«¯å®‰è£…ca (å·²ç»éªŒè¯)
åœ¨ Windows ä¸Šå®‰è£… PEM è¯ä¹¦æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

æ‰“å¼€ Windows ä¸­çš„â€œè¯ä¹¦ç®¡ç†å™¨â€
åœ¨ Windows æœç´¢æ ä¸­é”®å…¥â€œcertmgr.mscâ€ï¼Œç„¶åæŒ‰ Enter é”®æ‰“å¼€â€œè¯ä¹¦ç®¡ç†å™¨â€ã€‚

é€‰æ‹©è¯ä¹¦å­˜å‚¨ä½ç½®
åœ¨â€œè¯ä¹¦ç®¡ç†å™¨â€çª—å£ä¸­ï¼Œå±•å¼€â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€æ–‡ä»¶å¤¹ï¼Œå¹¶å³é”®å•å‡»â€œè¯ä¹¦â€æ–‡ä»¶å¤¹ã€‚åœ¨å³é”®èœå•ä¸­é€‰æ‹©â€œæ‰€æœ‰ä»»åŠ¡â€ ->â€œå¯¼å…¥â€ï¼Œæ‰“å¼€â€œè¯ä¹¦å¯¼å…¥å‘å¯¼â€å¯¹è¯æ¡†ã€‚

é€‰æ‹©è¯ä¹¦æ–‡ä»¶
åœ¨â€œè¯ä¹¦å¯¼å…¥å‘å¯¼â€å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©â€œä¸‹ä¸€æ­¥â€ï¼Œç„¶åç‚¹å‡»â€œæµè§ˆâ€æŒ‰é’®ï¼Œé€‰æ‹© PEM è¯ä¹¦æ–‡ä»¶ï¼Œå¹¶é€‰æ‹©â€œæ‰“å¼€â€ã€‚


macOS

    åŒå‡» ca.cert.pem
    é’¥åŒ™ä¸²è®¿é—® â†’ æ‰¾åˆ° â€œMyCompany Internal Root CAâ€
    åŒå‡» â†’ â€œä¿¡ä»»â€ â†’ â€œä½¿ç”¨æ­¤è¯ä¹¦æ—¶ï¼šå§‹ç»ˆä¿¡ä»»â€
    å…³é—­çª—å£ï¼Œè¾“å…¥å¯†ç ä¿å­˜



linux
sudo cp ca.cert.pem /usr/local/share/ca-certificates/mycompany-root-ca.crt
sudo update-ca-certificates

    
Androidï¼ˆ7.0+ï¼‰

    è®¾ç½® â†’ å®‰å…¨ â†’ åŠ å¯†ä¸å‡­æ® â†’ å®‰è£…è¯ä¹¦ â†’ CA è¯ä¹¦
    é€‰æ‹© ca.cert.pem
    é‡å‘½åï¼ˆå»æ‰ .pemï¼‰â†’ å®‰è£…
    âš ï¸ éƒ¨åˆ† Appï¼ˆå¦‚ Chromeï¼‰é»˜è®¤ä¸ä¿¡ä»»ç”¨æˆ· CA â†’ éœ€é…ç½® Network Security Configï¼ˆè§ä¸‹æ–‡ï¼‰

iOS

    é€šè¿‡é‚®ä»¶/AirDrop/ç½‘é¡µä¸‹è½½ ca.cert.pem
    ç‚¹å‡»å®‰è£… â†’ è®¾ç½® â†’ é€šç”¨ â†’ å…³äºæœ¬æœº â†’ è¯ä¹¦ä¿¡ä»»è®¾ç½®
    å¯ç”¨å¯¹ â€œMyCompany Internal Root CAâ€ çš„å®Œå…¨ä¿¡ä»»

App å¼€å‘è€…æ³¨æ„ï¼ˆAndroid Network Security Configï¼‰
res/xml/network_security_config.xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <domain-config>
        <domain includeSubdomains="true">192.168.1.100</domain>
        <domain includeSubdomains="true">myapp.local</domain>
        <trust-anchors>
            <certificates src="@raw/mycompany_ca"/>
            <certificates src="system" />
        </trust-anchors>
    </domain-config>
</network-security-config>
ca.cert.pem æ”¾å…¥ res/raw/mycompany_ca.pemï¼ˆå»æ‰ .pem åç¼€ï¼‰

åœ¨ AndroidManifest.xml ä¸­å¼•ç”¨ï¼š
<application
    android:networkSecurityConfig="@xml/network_security_config"
    ... >


------------------------------------------------------------------------------------

è‡ªåŠ¨åŒ–è„šæœ¬ï¼šä¸€é”®ç­¾å‘æ–°è¯ä¹¦
#!/bin/bash
# æ–‡ä»¶åï¼šissue-cert.sh

# ç”¨æ³•ï¼š./issue-cert.sh 192.168.1.100 myapp.local db.local

if [ $# -eq 0 ]; then
    echo "âŒ è¯·æŒ‡å®šè‡³å°‘ä¸€ä¸ªåŸŸåæˆ–IP"
    echo "âœ… ç”¨æ³•ï¼š./issue-cert.sh 192.168.1.100 myapp.local ..."
    exit 1
fi

DOMAINS=("$@")
COMMON_NAME="${DOMAINS[0]}"
CERT_NAME=$(echo "$COMMON_NAME" | tr '.' '_')

echo "ğŸ”‘ ç”Ÿæˆç§é’¥..."
openssl genrsa -out private/${CERT_NAME}.key.pem 2048

echo "ğŸ“ ç”Ÿæˆ CSR..."
SUBJ="/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=$COMMON_NAME"

# ç”Ÿæˆ SAN æ‰©å±•
SAN=""
for d in "${DOMAINS[@]}"; do
    if [[ $d =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        SAN="${SAN}IP:$d,"
    else
        SAN="${SAN}DNS:$d,"
    fi
done
SAN=${SAN%,}  # å»æ‰æœ«å°¾é€—å·

echo "subjectAltName=$SAN" > ${CERT_NAME}.ext

openssl req -new -key private/${CERT_NAME}.key.pem \
    -out ${CERT_NAME}.csr \
    -subj "$SUBJ"

echo "âœï¸  ç­¾å‘è¯ä¹¦..."
openssl x509 -req -in ${CERT_NAME}.csr \
    -CA certs/ca.cert.pem \
    -CAkey private/ca.key.pem \
    -CAcreateserial \
    -out certs/${CERT_NAME}.cert.pem \
    -days 365 \
    -sha256 \
    -extfile ${CERT_NAME}.ext

echo "âœ… è¯ä¹¦å·²ç”Ÿæˆï¼š"
echo "   ç§é’¥ï¼šprivate/${CERT_NAME}.key.pem"
echo "   è¯ä¹¦ï¼šcerts/${CERT_NAME}.cert.pem"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm ${CERT_NAME}.csr ${CERT_NAME}.ext

ä½¿ç”¨ä»¥ä¸‹è„šæœ¬
chmod +x issue-cert.sh
./issue-cert.sh 192.168.1.100 myapp.local api.local


åŠé”€è¯ä¹¦ï¼š
# åŠé”€è¯ä¹¦
openssl ca -revoke certs/server.cert.pem -keyfile private/ca.key.pem -cert certs/ca.cert.pem

# ç”ŸæˆåŠé”€åˆ—è¡¨ï¼ˆCRLï¼‰
openssl ca -gencrl -keyfile private/ca.key.pem -cert certs/ca.cert.pem -out crl/crl.pem
åœ¨ Nginx ä¸­å¯ç”¨ CRL æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰ï¼š
ssl_crl /path/to/internal-ca/crl/crl.pem;


