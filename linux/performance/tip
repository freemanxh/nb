1ã€top
c æŸ¥çœ‹å…¨è·¯å¾„
H çœ‹çº¿ç¨‹

2ã€iostat è®¾å¤‡çº§I/Oç»Ÿè®¡

iostat -x nvme0n1 1
iostat -p sda 1
iostat -p nvme0n1 1

 1. è®¾å¤‡é¥±å’Œï¼Ÿ
    %util > 80% ä¸”æŒç»­ â†’ è®¾å¤‡å¿™
    avgqu-sz > 1 â†’ è¯·æ±‚æŽ’é˜Ÿ
    
 2. I/O å»¶è¿Ÿé«˜ï¼Ÿ
    await > 10msï¼ˆHDDï¼‰æˆ– > 1msï¼ˆSSDï¼‰â†’ æ…¢ï¼
    r_await / w_await å•ç‹¬é«˜ â†’ è¯»/å†™æ…¢

æ£€æµ‹ I/O ç“¶é¢ˆï¼ˆawait > 10ms æˆ– %util > 80%ï¼‰
iostat -x 1 | awk '$14>10 || $NF>80 {print "ðŸš¨ I/O ç“¶é¢ˆï¼è®¾å¤‡: " $1 ", await=" $14 "ms, %util=" $NF "%"}'

3ã€sar

sudo vim /etc/default/sysstat
ENABLED="true"
sudo systemctl enable sysstat
sudo systemctl start sysstat

#æŸ¥çœ‹æ˜¨å¤© CPU å³°å€¼ï¼ˆå‡è®¾æ˜¨å¤©æ˜¯ 13 å·ï¼‰
sar -u -f /var/log/sysstat/sa13 | awk 'NR>3 {max=($8>max)?$8:max} END {print "Yesterday max %idle: " max "%"}'
#æ£€æµ‹ I/O ç“¶é¢ˆï¼ˆ%iowait > 20%ï¼‰
sar -u 1 10 | awk '$6>20 {print "ðŸš¨ I/O ç“¶é¢ˆï¼%iowait=" $6 "% at " $1 " " $2}'
#æŸ¥çœ‹å†…å­˜ä½¿ç”¨è¶‹åŠ¿ï¼ˆä»Šå¤©ï¼‰
sar -r | awk 'NR>3 {print $1, $5}' | column -t
#æ‰¾å‡ºå“ªä¸ªæ—¶é—´æ®µç£ç›˜æœ€å¿™ï¼ˆ%util > 80%ï¼‰
sar -d -p -f /var/log/sa/sa01 | awk '$12>80 {print "ðŸš¨ é«˜è´Ÿè½½ï¼è®¾å¤‡: " $2 ", æ—¶é—´: " $1 " " $2 ", %util=" $12 "%"}'
#ç›‘æŽ§ç½‘å¡æµé‡ï¼ˆeth0ï¼‰
sar -n DEV 1 | grep eth0

##ã€æ›´æ”¹sarçš„æ—¥å¿—é‡‡é›†é¢‘çŽ‡
/etc/default/sysstat
ENABLED="true"

/etc/cron.d/sysstat
*/10 * * * * root /usr/lib/sysstat/sa1 1 1 
æ”¹ä¸º1åˆ†é’Ÿ
*/1 * * * * root /usr/lib/sysstat/sa1 1 1

sudo systemctl reload cron 


# è‡ªåŠ¨æ¸…ç†æ—§æ•°æ® 
ç¼–è¾‘ /etc/logrotate.d/sysstat
/var/log/sa/sa* {
    weekly
    rotate 4
    compress
    missingok
    notifempty
}

4ã€lsof
lsof -p pid
lsof -u xuhui
lsof -i:port
#æŸ¥çœ‹æ–‡ä»¶è¢«è°å ç”¨
sudo lsof æ–‡ä»¶è·¯å¾„
#æ‰¾å‡ºæ‰€æœ‰ç›‘å¬ç«¯å£çš„è¿›ç¨‹
sudo lsof -i -sTCP:LISTEN
#æ‰¾å‡ºæ‰€æœ‰è¢«åˆ é™¤ä½†ä»å ç”¨çš„æ–‡ä»¶
sudo lsof +L1
sudo lsof | grep deleted
#æ‰¾å‡ºè®¿é—®æŸä¸ª IP çš„æ‰€æœ‰è¿žæŽ¥
sudo lsof -i @8.8.8.8
#æ‰¾å‡ºæ‰€æœ‰ TCP ESTABLISHED è¿žæŽ¥
sudo lsof -i -sTCP:ESTABLISHED

5ã€fuser
æŸ¥çœ‹è°åœ¨å ç”¨æŸä¸ªæ–‡ä»¶ï¼ˆè§£å†³â€œåˆ ä¸æŽ‰/æ”¹ä¸äº†â€ï¼‰
fuser -v /var/log/nginx/access.log
æ‰¾å‡ºå¹¶æ€æ­»å ç”¨æ—¥å¿—æ–‡ä»¶çš„è¿›ç¨‹
sudo fuser -k /var/log/myapp.log
æŸ¥çœ‹è°åœ¨å ç”¨æŸä¸ªç«¯å£ï¼ˆè§£å†³ç«¯å£å†²çªï¼‰
fuser 80/tcp
fuser 3306/tcp
æŸ¥çœ‹è°åœ¨å ç”¨æŸä¸ªè®¾å¤‡/æŒ‚è½½ç‚¹ï¼ˆè§£å†³â€œæ— æ³• umountâ€ï¼‰
fuser -vm /mnt/usb
fuser -vm /dev/sdb1

# 1. æŸ¥çœ‹è°åœ¨ç”¨
fuser -vm /mnt/usb
# 2. äº¤äº’å¼æ€æ­»
sudo fuser -kmi /mnt/usb
# 3. å¸è½½
sudo umount /mnt/usb

åœ¨ Docker å®¹å™¨ä¸­ä½¿ç”¨ fuserï¼ˆéœ€æƒé™ï¼‰
# åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹å ç”¨
sudo fuser -v /var/lib/docker/overlay2/å®¹å™¨ID/merged/path/to/file

6ã€vmstat
vmstat -aw 1
vmstat 1

procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 123456  78900 456789    0    0    10    20  100 200 10  5 85  0  0
 
 r>cores é«˜ â†’ CPU å¿™ï¼›b>0 é«˜ â†’ ç£ç›˜/ç½‘ç»œå¡
 si/so æŒç»­ > 0 â†’ ç³»ç»Ÿåœ¨ç–¯ç‹‚æ¢é¡µ â†’ æ€§èƒ½æš´è·Œï¼
 wa é«˜ â†’ ç£ç›˜æ…¢ï¼›us+sy é«˜ä¸” id ä½Ž â†’ CPU å¿™ï¼›st é«˜ â†’ è™šæ‹Ÿæœºå®¿ä¸»æœºè¿‡è½½
 
 è¯Šæ–­ I/O ç“¶é¢ˆ
vmstat 1
# è§‚å¯Ÿï¼šb > 0, wa > 20%, bi/bo é«˜
è¯Šæ–­å†…å­˜ä¸è¶³
vmstat -a 1
# è§‚å¯Ÿï¼šsi/so > 0, free æŒç»­ä¸‹é™, inactive ä¸å¢žé•¿
è¯Šæ–­ CPU ç“¶é¢ˆ
vmstat 1
# è§‚å¯Ÿï¼šr > CPUæ ¸æ•° ä¸” id < 20%

======================================================================

4ã€ssh-copy-id
ssh-copy-id "-p 22000 nameB@machineB"

5ã€å¢žåŠ userå¹¶åŠ å…¥sudoç»„
adduser xuhui
usermod -aG sudo xuhui
